<!DOCTYPE html>
<html lang="en-us">
  
  <head>
  <meta charset="UTF-8">
  <title>scBASE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/cayman.css">
</head>

  <body>
    <section class="page-header">
  <h1 class="project-name">scBASE</h1>
  <h2 class="project-tagline">Zero-and-One Inflated Model for estimating allelic proportion from scRNA-Seq data</h2>
  <a href="https://github.com/churchill-lab/scBASE" class="btn">View on GitHub</a>
  <a href="https://github.com/churchill-lab/scBASE/zipball/master" class="btn">Download .zip</a>
  <a href="https://github.com/churchill-lab/scBASE/tarball/master" class="btn">Download .tar.gz</a>
</section>

    <section class="main-content">
      
      <p><strong>scBASE</strong> is a python implementation of “soft” zero-and-one inflated beta-binomial (<strong>ZOIBB</strong>) model for estimating cellular allelic proportions in which we tackle data sparsity and variability by harnessing information derived from cell's population context.</p>

<ul>
  <li>Free software: MIT license</li>
<!--   <li>Full documentation: <a href="https://scbase.readthedocs.io/en/latest/readme.html">https://scbase.readthedocs.io/en/latest/readme.html</a></li> -->
</ul>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p><strong>Note:</strong> Although scBASE is available at <a href="https://pypi.python.org/pypi/scbase/">PyPI</a> for <code>pip install</code> or <code>easy_install</code>, we highly recommend using <a href="https://www.continuum.io/downloads">Anaconda distribution</a> of python to install all the dependencies without issues. scBASE is also available on <a href="https://anaconda.org/kbchoi/scbase">Anaconda Cloud</a>, so add the following channels if you have not already:</p>

<pre><code><strong>$</strong> conda config --add channels conda-forge
<strong>$</strong> conda config --add channels bioconda</code></pre>

<p>To avoid conflicts among dependencies, we also highly recommend using conda virtual environment:</p>

<pre><code><strong>$</strong> conda create -n scbase python=3
<strong>$</strong> source activate scbase</code></pre>

<p>Once scBASE virtual environment is created and activated, your shell prompt will show ‘(scbase)’ at the beginning to specify what virtual environment you are currently in. Now please type the following and install the dependencies for scBASE first.:</p>

<pre><code>(scbase) <strong>$</strong> conda install pystan click future scipy
(scbase) <strong>$</strong> pip install loompy
</code></pre>

<p>It is now ready to install scBASE. Note compiling stan code takes a while (several minutes depending on system resource).</p>
<pre><code>(scbase) <strong>$</strong> python setup.py install</code></pre>
    
<p>That's all! Now scBASE is available. Once you are done using scBASE, you can go out from scBASE virtual environment anytime:</p>

<pre><code>(scbase) <strong>$</strong> source deactivate
</code></pre>

<h2><a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>We assume that users have allele-specific read counts in a <a href="http://loompy.org">loom format</a> file (where total read counts of genes are stored in the default data layer and allele-specific counts are in each allele layer using allele codes as layer keys, 'Mat' and 'Pat' for example). Or scBASE can create a loom file using allele-specific read count file(s), tab-delimited text in the following format. Users can also create count files using the results from RSEM, kallisto, or even from counting uniquely-mapping reads. The count file can contain multiple samples (or cells) as long as each sample ID is specified using a header <code>#sample_id:</code>.</p>

<pre><code>#target_id	&lt;maternal_allele_code&gt;	&lt;paternal_allele_code&gt;	total
#sample_id: &lt;Cell_ID_1&gt;
&lt;Gene_ID_1&gt;	&lt;maternal_allele_count&gt;	&lt;paternal_allele_count&gt;	&lt;total_count&gt;
&lt;Gene_ID_2&gt;	&lt;maternal_allele_count&gt;	&lt;paternal_allele_count&gt;	&lt;total_count&gt;
...
#sample_id: &lt;Cell_ID_2&gt;
&lt;Gene_ID_1&gt;	&lt;maternal_allele_count&gt;	&lt;paternal_allele_count&gt;	&lt;total_count&gt;
&lt;Gene_ID_2&gt;	&lt;maternal_allele_count&gt;	&lt;paternal_allele_count&gt;	&lt;total_count&gt;
...
</code></pre>

<p>For example, the following file was created by <a href="http://churchill-lab.github.io/emase-zero/">emase-zero</a> using reads from F1 hybrid mouse of C57BL/6J male and CAST/EiJ female (parental haplotypes denoted as <code>B</code> and <code>F</code> respectively). It has four columns: the first column is for alignment target ID's, followed by the read counts of alleles, and then, the total.</p>
<pre><code>#target_id	B	F	total
#sample_id: SRR1041728
ENSMUSG00000000001	1394.25216017	334.74783983	1729.0
ENSMUSG00000000003	0.0	0.0	0.0
ENSMUSG00000000028	843.0	2.85744524983e-63	843.0
...
#sample_id: SRR1041729
ENSMUSG00000000001	30.9238234732	0.0761765268472	31.0
ENSMUSG00000000003	0.0	0.0	0.0
ENSMUSG00000000028	554.935510723	1053.06448928	1608.0
...
</code></pre>

<h3><a id="collate" class="anchor" href="#collate" aria-hidden="true"><span class="octicon octicon-link"></span></a>subcommand: <strong>collate</strong></h3>
<p>We can collate the allele-specific count information and store it in a loom file using <code>collate</code> subcommand. scBASE can process multiple count files if the name is specified using wildcard characters (<code>*</code> or <code>?</code>).</p>
<pre><code>Usage: scbase collate [OPTIONS] &lt;indir&gt; &lt;loomfile&gt;

  Utility function that collates input/output files

  Options:
    --counts
    --params
    --name TEXT                     File name (wildcard characters are supported)
    -m, --model &lt;ase_model&gt; &lt;tgx_model&gt;
    -v, --verbose                   '-v' is Level 1 and '-vv' is Level 2
    --help                          Show this message and exit.
</code></pre>

<p>For example, the following command will collate allele-specific counts from all the files whose name has the pattern of <code>*.gene.counts</code> in the folder <code>/fastscratch/myproject1</code> and create a loom file named <code>proj1.loom</code>.</p>
<pre><code><strong>$</strong> scbase collate --counts --name *.gene.counts /fastscratch/myproject1 proj1.loom
</code></pre>

<h3><a id="select" class="anchor" href="#select" aria-hidden="true"><span class="octicon octicon-link"></span></a>subcommand: <strong>select</strong></h3>
<p>We can select genes for fitting with ZOIBB model according to the minumum numbers of cells that satisfy the minimum number of reads expressed from a gene using <code>select</code> subcommand.</p>
<pre><code>Usage: scbase select [OPTIONS] &lt;loomfile&gt;

  Select genes if they are expressed at least &lt;min_read_count&gt; in at least
  &lt;min_cell_count&gt; cells

  Options:
    --min-read-count &lt;min_read_count&gt; Min read count required
    --min-cell-count &lt;min_cell_count&gt; Min cell count required
    --layer &lt;layer_key&gt;               The layer to consider selection
    -v, --verbose                     The more times listed, the more output
    --help                            Show this message and exit.
</code></pre>
<p>For example, the following command will filter out genes that were not expressed in at least 4 reads over in at least 16 cells, and then, mark selected genes in a row attribute (<code>ra.Selected</code>) of the input loom file so the next procedure <code>run_mcmc</code> will only run on those selected genes.</p>
<pre><code><strong>$</strong> scbase select --min-read-count 4 --min-cell-count 16 proj1.loom</code></pre>

<h3><a id="mcmc" class="anchor" href="#collate" aria-hidden="true"><span class="octicon octicon-link"></span></a>subcommand: <strong>run_mcmc</strong></h3>
<p>Once input data is ready in a loom file, we can fit ZOIBB model using <code>run_mcmc</code> subcommand.</p>
<pre><code>Usage: scbase run_mcmc [OPTIONS] &lt;npzfile&gt;

  Run MCMC implementation of ZOIBB model

  Options:
    --hapcode &lt;mat_hapcode&gt; &lt;pat_hapcode&gt;
    -m, --model &lt;ase_model&gt; &lt;tgx_model&gt;
    -s, --start &lt;gidx_start&gt;      Starting gene (row index)
    -e, --end &lt;gidx_end&gt;          Ending gene (row index)
    -o, --outfile &lt;outfile&gt;
    -v, --verbose                 '-v' is Level 1 and '-vv' is Level 2
    --help                        Show this message and exit.
</code></pre>

<p>For example, the following command will fit the model for the first six genes in the loom file, <code>proj1.loom</code> and save the results in a file named <code>scbase.0-6.param.npz</code>. Haplotype code should be given in the order of maternal and paternal allele.</p>
<pre><code><strong>$</strong> scbase run_mcmc proj1.loom -s 0 -e 6 --hapcode F B</code></pre>

<h3><a id="submit" class="anchor" href="#submit" aria-hidden="true"><span class="octicon octicon-link"></span></a>subcommand: <strong>submit</strong></h3>
<p>Running MCMC for tens of thousands of genes would be time consuming but we can parallelize it using HPC cluster systems. We can submit jobs automatically using <code>submit</code> subcommand.</p>
<pre><code>Usage: scbase submit [OPTIONS] &lt;loomfile&gt;
  
  Submit jobs to HPC clusters
  
  Options:
    --hapcode &lt;mat_hapcode&gt; &lt;pat_hapcode&gt;
    -m, --model &lt;ase_model&gt; &lt;tgx_model&gt;
    -c, --chunk &lt;chunk_size&gt;        Chunk size
    -o, --outdir &lt;outdir&gt;
    --systype &lt;systype&gt;             Type of HPC cluster system (default: pbs)
    --email &lt;email&gt;                 Notification E-mail
    --queue &lt;queue&gt;                 Queue name
    --mem &lt;mem&gt;                     Memory in GB (default: 16GB)
    --walltime &lt;walltime&gt;           Walltime in hours (default: 24h
    --dryrun
    -v, --verbose                   '-v' is Level 1 and '-vv' is Level 2
    --help                          Show this message and exit.
</code></pre>

<p>For example, the following comand will submit jobs to PBS cluster, each fits 50 genes in <code>proj1.loom</code> file and save the results in files named <code>scbase.{gidx_start}-{gidx_end}.param.npz</code> in <code>/fastscratch/myproject1</code> folder.</p>
<pre><code><strong>$</strong> scbase submit -o /fastscratch/myproject1 --systype pbs --chunk 50 --hapcode F B proj1.loom
</code></pre>

<p>Then we collate the model parameters and store in the input loom file, <code>proj1.loom</code> so that we can now have all the information in a single file.</p>
<pre><code><strong>$</strong> scbase collate --params /fastscratch/myproject1 proj1.loom
</code></pre>

<p>The <code>proj1.loom</code> file contains the following.</p>
<pre class="ipython"><code>In [1]: import loompy

In [2]: ds = loompy.connect('proj1.loom')

In [3]: ds.layers.keys()
Out[3]:
['',
 'B',
 'F',
 'lambda_k',
 'p_k',
 'pi_bk',
 'pi_mk',
 'pi_pk']

In [4]: ds.ra.keys()
Out[4]:
['GeneID',
 'Rhat_ase',
 'Rhat_tgx',
 'alpha_ase1',
 'alpha_ase2',
 'alpha_mono',
 'alpha_tgx1',
 'alpha_tgx2',
 'pi_b',
 'pi_m',
 'pi_p',
 'Selected',
 'Symbol',
 'Valid']

In [5]: ds.ca.keys()
Out[5]: ['CellID', 'CellType', 'Selected', 'Size', 'Valid']

In [6]: ds.close()

</code></pre>
<p>Among others <code>layers['lambda_k']</code> is "normalized" gene expression count per cell and <code>layers['p_k']</code> contains the final "partial pooled" allelic proportion per cell. (Note: Each layer in a loom file has a dimensionality of |num_genes|x|num_cells|.) The proportion of paternal monoallelic, bi-allelic, and maternal monoallelic cells are in <code>ra['pi_p']</code>, <code>ra['pi_b']</code>, and <code>ra['pi_m']</code>. Cell level probability of allelic expression states are available at the layers of <code>layers['pi_pk']</code>, <code>layers['pi_bk']</code>, and <code>layers['pi_mk']</code>.</p>

<div id="home">
  <h2>Announcements</h2>
  <ul class="posts">
    
      <li><span>24 Oct 2018</span> &raquo; <a href="/main/2018/10/24/welcome.html">Welcome to scBASE!</a></li>
    
  </ul>
</div>

      <footer class="site-footer">
  <span class="site-footer-owner"><a href="">scBASE</a> is maintained by <a href="https://www.jax.org/research-and-faculty/faculty/research-scientists/kb-choi">Kwangbom "KB" Choi</a>.</span>
  <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
</footer>


    </section>

  </body>
</html>
